## DAREN Product Backlog (living doc)

Короткая «эссенция» договоренностей и задач по приложению. Обновляется по мере обсуждений.

### 1) Вижен и цель
- **Цель**: показывать корректные метрики (PnL, ROI, статус TP/SL), рекомендации и аналитику на дашборде, опираясь на реальные сделки и новости.
- **Критично**: корректный «финал сделки» и консистентная база с поддержкой стратегий управления позицией.

### 2) Текущий статус (веб/инфра)
- Веб (Next.js) задеплоен на Vercel; API-роуты активны. 
- Supabase настроен, env-переменные выведены в Vercel. 
- Сервер Дарэна крутит движки в tmux, основная SQLite: `/root/ghost_system_final/ghost_system_final_146/ghost.db`.

### 3) Ключевая проблема
- **Неверный финальный PnL/ROI**: при стратегии «два TP + перевод стопа в BE» биржа иногда отдает только финальный TP2 по `orderId`. 
- Первая часть выхода (TP1) не учитывается → расчеты «финала» искажены. Источник истины «bybit_full_match» требует правильной агрегации по ногам/филам/комиссиям.

### 4) Область ответственности модулей (упрощенно)
- Открытие сделки — отдельный модуль (фиксирует вход).
- Закрытие/финал — `position_exit_tracker` (большой файл, сейчас считает неверно).
- Движки новостей/цен — формируют данные для сигналов; синхронизация в Supabase через `supabase_sync.py`.

### 5) Требования к стратегиям (MVP → расширение)
- MVP-стратегия: 2 TP + перенос стопа в BE после TP1.
- Расширение: 
  - Гибкое распределение объема (весь объем на TP2, дробление 70/30 и т.д.).
  - Динамический/трейлинговый стоп (зависимость от цены).
  - Конфигурируемые правила стратегий (YAML/таблица в БД).

### 6) База/данные (предлагаемая структура для Supabase)
- `trades` (позиция в целом): id, signal_id, symbol, side, entry_avg, size_total, leverage, fees_total, pnl_realized, roi, status, opened_at, closed_at, strategy_id.
- `trade_legs` (выход ногами): trade_id, leg_no, exit_type (TP/SL/partial), price, size, fee, ts.
- `fills_raw` (сырье от биржи): execId/orderId/linkId, side, price, size, fee, ts, source.
- `strategies` (правила): id, name, allocation, be_rules, trailing_rules.
- `pnl_snapshots` (история пересчетов/диагностика): trade_id, calc_version, fields_dump, ts.

### 7) Задачи (Backlog)
- [High] Исправить расчет финала в `position_exit_tracker`:
  - Сопоставление фидов: объединять TP1/TP2 по linkId/orderId/execId; уметь реконструировать, если виден только TP2.
  - Поддержать частичные выходы (legs), комиссии, левередж, BE после TP1.
  - Юнит-тесты на реальных трейдах (#692, #772 и др.).
- [High] Синхронизация в Supabase:
  - `supabase_sync.py` → выгружать очищенные `trades`, `trade_legs`, `pnl_snapshots`.
  - Идемпотентность (не дублировать по `local_id`/`trade_id`).
- [Med] Конфигурация стратегий:
  - Хранение и загрузка правил (allocation/BE/trailing) из таблицы/конфига.
- [Med] Дашборд «Top opportunities» и подробная карточка сделки:
  - Аггр. endpoint рекомендаций; визуал PnL по ногам, отметки TP/SL, BE.
- [Low] Мониторинг/алерты:
  - Статусы пайплайна, метрики рассогласований, Telegram-уведомления о пересчетах.

### 8) Принципы расчета финала (ожидаемая логика)
- Реализованный PnL = Σ по ногам[(exit_price - entry_avg) × size × dir] − Σ fees.
- ROI учитывает плечо и размер используемой маржи; BE после TP1 фиксирует минимум 0 по остатку.
- Если из биржи доступен только TP2 — реконструируем TP1 из локальных логов/снимков/сигналов (или помечаем trade как `partial_observed` и пересчитываем позже при появлении данных).

### 9) Данные/артефакты для отладки
- Сервер Дарэна: свежая `ghost.db` (≈13 MB), логи `logs/`, дампы сделок, снапшоты.
- Примеры некорректных кейсов (от Дарэна): «две ноги, видим лишь вторую», номера сделок и скриншоты финальных отчётов.

### 10) Ближайшие шаги (последовательность)
1) Ничего не менять в проде без согласования.
2) Считать образцы сделок из `ghost.db` и выписать эталонные результаты руками (PnL/ROI/legs).
3) Выделить вычислительное ядро `position_exit_tracker` в тестируемую функцию; написать тесты на кейсы TP1+TP2+BE.
4) Исправить агрегацию ног/комиссий; добавить реконструкцию недостающей ноги.
5) Прогнать тесты, согласовать результаты; включить в пайплайн и sync в Supabase.

### 11) Риски/ограничения
- Неполные данные по ордерам от биржи (частично наблюдаемые сделки).
- Несогласованность времени/ID между источниками.
- Потенциальные изменения формата API/филов.

### 12) Определение готовности (DoD) для «корректный финал сделки»
- Реальные примеры от Дарэна сходятся с расчетом (PnL/ROI) ± округления и комиссий.
- TP1/TP2/BE корректно отображаются в UI; legs видны и суммируются правильно.
- Синхронизация в Supabase идемпотентна; дашборд показывает те же значения.


