# üöÄ GHOST Position Exit Tracker v2.0 - Changelog

## üìã –û–±–∑–æ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π

**–§–∞–π–ª:** `position_exit_tracker.py`  
**–í–µ—Ä—Å–∏—è:** v2.0 (fills-first + fallback)  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ë–æ–µ–≤–æ–π –≥–æ—Ç–æ–≤—ã–π  
**–î–∞—Ç–∞:** 2025-01-27

## üéØ –û—Å–Ω–æ–≤–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### 1. Fills-First –ª–æ–≥–∏–∫–∞ —Ä–∞—Å—á—ë—Ç–∞ PnL/ROI

**–ü—Ä–æ–±–ª–µ–º–∞:** –¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è —Å—á–∏—Ç–∞–µ—Ç —Å–µ–≥–º–µ–Ω—Ç—ã TP1/TP2 –ø–æ —Ñ–æ—Ä–º—É–ª–µ —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∫–æ–º–∏—Å—Å–∏–µ–π 0.055% –∏ —Å –æ–ø–æ—Ä–æ–π –Ω–∞ —Ñ–ª–∞–≥–∏ `tp2_hit`, —á—Ç–æ –¥–∞—ë—Ç –æ—à–∏–±–∫–∏ –ø—Ä–∏ —á–∞—Å—Ç–∏—á–Ω—ã—Ö –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è—Ö, —Ä—É—á–Ω–æ–º –≤—ã—Ö–æ–¥–µ –∏/–∏–ª–∏ –Ω–µ–ø–æ–ª–Ω—ã—Ö —Ñ–ª–∞–≥–∞—Ö.

**–†–µ—à–µ–Ω–∏–µ:** –ü–µ—Ä–≤–æ–∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã ‚Äî fills –æ—Ç –±–∏—Ä–∂–∏; fallback ‚Äî —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Ñ–æ—Ä–º—É–ª–∞ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ fills –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –∏–ª–∏ –Ω–µ–ø–æ–ª–Ω—ã).

### 2. –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞—Å—á—ë—Ç–∞

#### `_get_executions(symbol, start_time, end_time)`
- –ü–æ–ª—É—á–∞–µ—Ç executions (fills) –æ—Ç Bybit API —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
- –§–∏–ª—å—Ç—Ä—É–µ—Ç –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–µ fills –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—é –ø–æ–∑–∏—Ü–∏–∏
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ API –∏ —Ç–∞–π–º–∞—É—Ç—ã

#### `_split_fills_by_legs(fills, qty_total, side)`
- –†–∞–∑–¥–µ–ª—è–µ—Ç fills –Ω–∞ TP1 (50%) –∏ –æ—Å—Ç–∞—Ç–æ–∫ (50%)
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç overfill –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–µ 50%
- –°–æ—Ä—Ç–∏—Ä—É–µ—Ç –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è

#### `_calc_from_fills(trade, fills)`
- –í—ã—á–∏—Å–ª—è–µ—Ç VWAP, –∫–æ–º–∏—Å—Å–∏–∏ –∏ PnL –¥–ª—è –∫–∞–∂–¥–æ–π –Ω–æ–≥–∏
- –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç exit_reason –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö —Ü–µ–Ω
- –§–æ—Ä–º–∏—Ä—É–µ—Ç exit_detail —Å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π

#### `_fallback_calc(trade, exit_price)`
- Fallback –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ª–æ–≥–∏–∫—É
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ fills
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ–±—Ä–∞—Ç–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

### 3. –£–ª—É—á—à–µ–Ω–Ω—ã–µ –ø–æ–ª—è –≤—ã—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

#### –ù–æ–≤—ã–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è:
```python
{
    "roi_source": "fills" | "fallback",
    "pnl_source": "fills" | "fallback", 
    "roi_calc_note": "ok" | "skip_calc: ..." | "fallback",
    "exit_detail": "fills: tp1@50% + be@50%",
    "pnl_tp1_net": float,
    "pnl_rest_net": float,
    "roi_tp1_real": float,
    "roi_rest_real": float,
    "bybit_fee_open": float,
    "bybit_fee_close": float,
    "bybit_fee_total": float
}
```

#### –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è:
- `exit_reason`: –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö fills
- `tp1_hit`, `tp2_hit`, `sl_hit`: –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ fills
- `pnl_final_real`, `roi_final_real`: –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ä–∞—Å—á—ë—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ fills

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã

1. **–û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–∑–∏—Ü–∏–∏** (size == 0)
2. **–ü–æ–ª—É—á–µ–Ω–∏–µ fills** –æ—Ç Bybit API (–æ–∫–Ω–æ: opened_at - 5–º–∏–Ω –¥–æ now + 1–º–∏–Ω)
3. **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ fills** –Ω–∞ TP1 (50%) –∏ –æ—Å—Ç–∞—Ç–æ–∫ (50%)
4. **–†–∞—Å—á—ë—Ç PnL/ROI** –¥–ª—è –∫–∞–∂–¥–æ–π –Ω–æ–≥–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ VWAP –∏ –∫–æ–º–∏—Å—Å–∏–π
5. **Fallback** –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ fills
6. **–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å API** get_closed_pnl
7. **–ó–∞–ø–∏—Å—å –≤ –ë–î** —Å –ø–æ–ª–Ω–æ–π –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –≥—Ä–∞–Ω–∏—á–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤

- **–ß–∞—Å—Ç–∏—á–Ω—ã–π TP1**: –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–µ–∂–µ–º fills –∏ —Å—á–∏—Ç–∞–µ–º VWAP
- **Overfill –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–µ 50%**: Fill –¥–µ–ª–∏—Ç—Å—è –Ω–∞ –¥–≤–µ —á–∞—Å—Ç–∏
- **–ü—É—Å—Ç—ã–µ fills**: –ü–µ—Ä–µ—Ö–æ–¥ –≤ fallback —Ä–µ–∂–∏–º
- **–ù–µ–ø–æ–ª–Ω—ã–µ fills**: –ß–∞—Å—Ç–∏—á–Ω—ã–π —Ä–∞—Å—á—ë—Ç —Å –ø–æ–º–µ—Ç–∫–æ–π
- **–û—à–∏–±–∫–∏ API**: Graceful degradation –∫ fallback

### –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è
- ‚úÖ –§–æ—Ä–º–∞—Ç –ª–æ–≥–æ–≤ –∏ —Å–æ–±—ã—Ç–∏–π –Ω–µ –∏–∑–º–µ–Ω—ë–Ω
- ‚úÖ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è–º–∏
- ‚úÖ Fallback —Ä–µ–∂–∏–º –¥–ª—è —Å–ª—É—á–∞–µ–≤ –±–µ–∑ fills

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ù–æ–≤—ã–π —Ñ–∞–π–ª —Ç–µ—Å—Ç–æ–≤: `test_fills_calculation.py`

#### Unit —Ç–µ—Å—Ç—ã:
- `test_signed_profit()`: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—á—ë—Ç–∞ PnL –¥–ª—è LONG/SHORT
- `test_vwap_qty_fee()`: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å—á—ë—Ç–∞ VWAP –∏ –∫–æ–º–∏—Å—Å–∏–π
- `test_split_fills_by_legs()`: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è fills
- `test_calc_from_fills()`: –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ä–∞—Å—á—ë—Ç–∞
- `test_fallback_calc()`: –ü—Ä–æ–≤–µ—Ä–∫–∞ fallback –ª–æ–≥–∏–∫–∏

#### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã:
- `test_edge_cases()`: –ì—Ä–∞–Ω–∏—á–Ω—ã–µ —Å–ª—É—á–∞–∏
- `run_integration_test()`: –ü–æ–ª–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π —Å–¥–µ–ª–∫–∏

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤:
```bash
python test_fills_calculation.py
```

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–µ–π

| –ê—Å–ø–µ–∫—Ç | v1.4 | v2.0 |
|--------|------|------|
| –ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö | –§–æ—Ä–º—É–ª–∞ + —Ñ–ª–∞–≥–∏ | Fills –æ—Ç API + fallback |
| –¢–æ—á–Ω–æ—Å—Ç—å PnL | –ü—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–∞—è | –§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è |
| –ö–æ–º–∏—Å—Å–∏–∏ | –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ 0.055% | –†–µ–∞–ª—å–Ω—ã–µ –∏–∑ fills |
| TP1/TP2 —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ | –ü–æ —Ñ–ª–∞–≥–∞–º | –ü–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–º fills |
| –û–±—Ä–∞–±–æ—Ç–∫–∞ —á–∞—Å—Ç–∏—á–Ω—ã—Ö –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–π | –ù–µ—Ç | –î–∞ |
| –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã—Ö–æ–¥–∞ | –ë–∞–∑–æ–≤–∞—è | –ü–æ–ª–Ω–∞—è (exit_detail) |
| –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å API | –ï—Å—Ç—å | –£–ª—É—á—à–µ–Ω–æ |

## üöÄ –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ

### –ü–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω:

1. **–ë—ç–∫–∞–ø —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏:**
   ```bash
   cp position_exit_tracker.py position_exit_tracker_v1.4_backup.py
   ```

2. **–ó–∞–º–µ–Ω–∞ —Ñ–∞–π–ª–∞:**
   ```bash
   # –ù–æ–≤—ã–π —Ñ–∞–π–ª —É–∂–µ –≥–æ—Ç–æ–≤
   ```

3. **–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤:**
   ```bash
   python test_fills_calculation.py
   ```

4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ:**
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –Ω–æ–≤—ã–µ trace-–∫–æ–¥—ã
   - –°—Ä–∞–≤–Ω–∏—Ç—å PnL —Å API
   - –£–±–µ–¥–∏—Ç—å—Å—è –≤ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ exit_detail

### –ù–æ–≤—ã–µ trace-–∫–æ–¥—ã –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:

- `FILLS_FETCH_OK`: –£—Å–ø–µ—à–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ fills
- `FILLS_FETCH_EMPTY`: Fills –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
- `FILLS_CALC_OK`: –£—Å–ø–µ—à–Ω—ã–π —Ä–∞—Å—á—ë—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ fills
- `FILLS_PARTIAL_FALLBACK`: –ß–∞—Å—Ç–∏—á–Ω—ã–π fallback
- `FALLBACK_CALC_USED`: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –ø–æ–ª–Ω—ã–π fallback
- `FILLS_VS_API_MISMATCH`: –†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ —Å API > 1 —Ü–µ–Ω—Ç

## üéØ –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –£–ª—É—á—à–µ–Ω–∏—è —Ç–æ—á–Ω–æ—Å—Ç–∏:
- **PnL —Ä–∞—Å—á—ë—Ç**: –û—Ç –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∫ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–º—É
- **–ö–æ–º–∏—Å—Å–∏–∏**: –û—Ç —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫ —Ä–µ–∞–ª—å–Ω—ã–º
- **TP1/TP2 —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ**: –û—Ç —Ñ–ª–∞–≥–æ–≤ –∫ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–º fills
- **–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è**: –û—Ç –±–∞–∑–æ–≤–æ–π –∫ –ø–æ–ª–Ω–æ–π

### –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏:
- ‚úÖ –í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–æ–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã
- ‚úÖ –§–æ—Ä–º–∞—Ç –ª–æ–≥–æ–≤ –Ω–µ –∏–∑–º–µ–Ω—ë–Ω
- ‚úÖ Fallback —Ä–µ–∂–∏–º –¥–ª—è –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏
- ‚úÖ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

## üìù –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

Position Exit Tracker v2.0 –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ —Ç–æ—á–Ω–æ—Å—Ç–∏ —Ä–∞—Å—á—ë—Ç–∞ PnL/ROI –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–æ–ª–Ω–æ–π –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏. –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ–∫—É—Å –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ —Ä–µ–∞–ª—å–Ω—ã—Ö fills –æ—Ç –±–∏—Ä–∂–∏ –∫–∞–∫ –ø–µ—Ä–≤–æ–∏—Å—Ç–æ—á–Ω–∏–∫–∞ –∏—Å—Ç–∏–Ω—ã –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Ä–∞—Å—á—ë—Ç–æ–≤ –≤–æ –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö —Ç–æ—Ä–≥–æ–≤–ª–∏.

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤ –∫ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—é –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
