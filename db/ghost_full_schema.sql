-- üèÜ GHOST FULL DATABASE SCHEMA v1.1
-- –ü–æ–ª–Ω–∞—è —Å—Ö–µ–º–∞ –ø–æ—Å–ª–µ –∞—É–¥–∏—Ç–∞ —Å–∏–≥–Ω–∞–ª–æ–≤ —Å–æ–≥–ª–∞—Å–Ω–æ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ –î–∞—Ä—ç–Ω–∞
-- –ï–¥–∏–Ω–∞—è –ë–î: ghost.db
-- –°–ª–æ–∏: signals ‚Ä¢ candles_cache ‚Ä¢ trades ‚Ä¢ trade_events ‚Ä¢ trade_audits ‚Ä¢ strategies ‚Ä¢ strategy_results ‚Ä¢ traders ‚Ä¢ trader_stats ‚Ä¢ scenarios ‚Ä¢ scenario_results
-- –ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è ROI/PNL/–∫–æ–º–∏—Å—Å–∏–π: —Å—Ç—Ä–æ–≥–æ –∫–∞–∫ –≤ position_exit_tracker.py
-- –ù–æ—Ç–∞—Ü–∏—è —Ç–∏–ø–æ–≤: SQLite; JSON —Ö—Ä–∞–Ω–∏–º –∫–∞–∫ TEXT —Å –≤–∞–ª–∏–¥–Ω—ã–º JSON

-- =====================================
-- 1) SIGNALS ‚Äî –ø–µ—Ä–≤–∏—á–Ω–∞—è ¬´–ø—Ä–∞–≤–¥–∞¬ª —Å–∏–≥–Ω–∞–ª–∞ (immutable)
-- =====================================

CREATE TABLE IF NOT EXISTS signals (
    id TEXT PRIMARY KEY,                        -- UUID —Å–∏–≥–Ω–∞–ª–∞
    received_at INTEGER NOT NULL,               -- –í—Ä–µ–º—è –ø–æ–ª—É—á–µ–Ω–∏—è (unix ms)
    source_name TEXT NOT NULL,                  -- –ö–∞–Ω–∞–ª/–∏—Å—Ç–æ—á–Ω–∏–∫ (e.g. Whales Crypto Guide)
    source_id TEXT,                            -- –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π ID –∏—Å—Ç–æ—á–Ω–∏–∫–∞
    raw_text TEXT NOT NULL,                    -- –ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞
    symbol_raw TEXT NOT NULL,                  -- –ö–∞–∫ –≤ –ø–æ—Å—Ç–µ
    symbol TEXT NOT NULL,                      -- –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π (e.g. BELUSDT)
    side TEXT NOT NULL CHECK (side IN ('Buy', 'Sell')), -- Long/Short
    entry_low REAL NOT NULL,                   -- –ù–∏–∂–Ω—è—è –≥—Ä–∞–Ω–∏—Ü–∞ –≤—Ö–æ–¥–∞
    entry_high REAL NOT NULL,                  -- –í–µ—Ä—Ö–Ω—è—è –≥—Ä–∞–Ω–∏—Ü–∞ –≤—Ö–æ–¥–∞
    targets_json TEXT NOT NULL,                -- [tp1,tp2,...,tpN] (—Ü–µ–Ω—ã) JSON array
    stoploss REAL NOT NULL,                    -- SL –∏–∑ –ø–æ—Å—Ç–∞
    leverage_hint_min REAL,                    -- –ú–∏–Ω. –ø–ª–µ—á–æ
    leverage_hint_max REAL,                    -- –ú–∞–∫—Å. –ø–ª–µ—á–æ
    reason_text TEXT,                          -- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∞–≤—Ç–æ—Ä–∞
    parse_version TEXT NOT NULL,               -- –í–µ—Ä—Å–∏—è –ø–∞—Ä—Å–µ—Ä–∞
    parsed_ok INTEGER NOT NULL DEFAULT 1 CHECK (parsed_ok IN (0,1)), -- –§–ª–∞–≥ —É—Å–ø–µ—Ö–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞
    precision_hint_json TEXT,                  -- –¢–æ—á–Ω–æ—Å—Ç—å/—Ç–∏–∫-—Å–∞–π–∑/–º–∏–Ω.—à–∞–≥ JSON
    dedupe_hash TEXT,                          -- –ê–Ω—Ç–∏–¥—É–±–ª—å (–∏–Ω–¥–µ–∫—Å)
    created_at INTEGER DEFAULT (strftime('%s', 'now') * 1000)
);

-- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è signals
CREATE INDEX IF NOT EXISTS idx_signals_source_received ON signals(source_name, received_at);
CREATE INDEX IF NOT EXISTS idx_signals_symbol_received ON signals(symbol, received_at);
CREATE UNIQUE INDEX IF NOT EXISTS idx_signals_dedupe ON signals(dedupe_hash);

-- =====================================
-- 2) CANDLES_CACHE ‚Äî —Ä—ã–Ω–æ–∫/—Å–≤–µ—á–∏ (–∫–æ–Ω—Ç–µ–∫—Å—Ç –∏ –ø–æ—Ç–æ–∫)
-- =====================================

CREATE TABLE IF NOT EXISTS candles_cache (
    symbol TEXT NOT NULL,                      -- –¢–∏–∫–µ—Ä
    timeframe TEXT NOT NULL,                   -- –¢–§ (1m,5m,...)
    ts INTEGER NOT NULL,                       -- –ú–µ—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ —Å–≤–µ—á–∏ (unix ms, open time)
    open REAL NOT NULL,
    high REAL NOT NULL,
    low REAL NOT NULL,
    close REAL NOT NULL,
    volume REAL,
    load_source TEXT,                          -- rest/ws
    quality_flags TEXT,                        -- –ü—Ä–∏–∑–Ω–∞–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞/–ª–∞—Ç—á JSON
    created_at INTEGER DEFAULT (strftime('%s', 'now') * 1000),
    
    UNIQUE(symbol, timeframe, ts)
);

-- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è candles_cache
CREATE INDEX IF NOT EXISTS idx_candles_symbol_timeframe_ts ON candles_cache(symbol, timeframe, ts DESC);

-- =====================================
-- 3) TRADES ‚Äî —Å–¥–µ–ª–∫–∏ (—Ä–µ–∞–ª—å–Ω—ã–µ –∏ –±—É–º–∞–∂–Ω—ã–µ)
-- =====================================

CREATE TABLE IF NOT EXISTS trades (
    id TEXT PRIMARY KEY,                       -- UUID
    signal_id TEXT REFERENCES signals(id),     -- –°–≤—è–∑—å —Å —Å–∏–≥–Ω–∞–ª–æ–º
    mode TEXT NOT NULL CHECK (mode IN ('paper', 'real')), -- –†–µ–∂–∏–º
    status TEXT NOT NULL CHECK (status IN ('paper_open', 'open', 'closed')), -- –°—Ç–∞—Ç—É—Å
    symbol TEXT NOT NULL,                      -- –¢–∏–∫–µ—Ä
    side TEXT NOT NULL CHECK (side IN ('Buy', 'Sell')), -- –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    opened_at INTEGER NOT NULL,                -- –í—Ä–µ–º—è –æ—Ç–∫—Ä—ã—Ç–∏—è (–≤–∏—Ä—Ç./—Ñ–∞–∫—Ç)
    entry_type TEXT,                          -- zone_mid/market/limit
    entry_exec_price REAL,                   -- –§–∞–∫—Ç –≤—Ö–æ–¥–∞ (real)
    entry_price_virtual REAL,                -- –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –≤—Ö–æ–¥ (paper)
    entry_low REAL,                          -- –ö–æ–ø–∏—è –∑–æ–Ω—ã
    entry_high REAL,                         -- –ö–æ–ø–∏—è –∑–æ–Ω—ã
    tp_prices_json TEXT NOT NULL,            -- [tp1,tp2,...] JSON
    sl_price REAL NOT NULL,                  -- SL
    be_after_tp1 INTEGER DEFAULT 0 CHECK (be_after_tp1 IN (0,1)), -- BE –ø–æ—Å–ª–µ TP1 (–ø–ª–∞–Ω)
    margin_usd REAL,                         -- –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è (paper=100)
    leverage_plan REAL,                      -- –ü–ª–∞–Ω –ø–ª–µ—á–∞
    real_leverage REAL,                      -- –§–∞–∫—Ç –ø–ª–µ—á–∞ (real)
    qty REAL,                               -- –ö–æ–ª-–≤–æ (real)
    exit_time INTEGER,                       -- –í—Ä–µ–º—è –∑–∞–∫—Ä—ã—Ç–∏—è
    exit_reason TEXT,                        -- tp2/tp1_be/sl/manual/timeout
    exit_price REAL,                         -- –§–∞–∫—Ç/–≤–∏—Ä—Ç. –≤—ã—Ö–æ–¥
    tp1_hit INTEGER DEFAULT 0 CHECK (tp1_hit IN (0,1)), -- –§–∞–∫—Ç –∫–∞—Å–∞–Ω–∏—è TP1
    tp2_hit INTEGER DEFAULT 0 CHECK (tp2_hit IN (0,1)), -- –§–∞–∫—Ç –∫–∞—Å–∞–Ω–∏—è TP2
    tpN_hits_json TEXT,                      -- { "tp3":true, ... } JSON
    sl_hit INTEGER DEFAULT 0 CHECK (sl_hit IN (0,1)), -- –§–∞–∫—Ç –∫–∞—Å–∞–Ω–∏—è SL
    duration_sec INTEGER,                    -- –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
    bybit_fee_open REAL,                     -- –ö–æ–º–∏—Å—Å–∏—è –≤—Ö–æ–¥
    bybit_fee_close REAL,                    -- –ö–æ–º–∏—Å—Å–∏—è –≤—ã—Ö–æ–¥
    bybit_fee_total REAL,                    -- –ö–æ–º–∏—Å—Å–∏–∏ –≤—Å–µ–≥–æ
    bybit_pnl_net_api REAL,                  -- –ò—Å—Ç–∏–Ω–Ω—ã–π PnL –∏–∑ API
    pnl_tp1_net REAL,                        -- Net PnL –Ω–æ–≥–∏ TP1
    pnl_tp2_net REAL,                        -- Net PnL –Ω–æ–≥–∏ TP2/BE
    pnl_final_real REAL,                     -- –ò—Ç–æ–≥–æ–≤—ã–π PnL (fallback)
    roi_tp1_real REAL,                       -- ROI TP1 –æ—Ç –º–∞—Ä–∂–∏
    roi_tp2_real REAL,                       -- ROI TP2/BE –æ—Ç –º–∞—Ä–∂–∏
    roi_final_real REAL,                     -- –ò—Ç–æ–≥–æ–≤—ã–π ROI –æ—Ç –º–∞—Ä–∂–∏
    roi_ui REAL,                            -- UI-ROI (–ø–æ –º–µ—Ç–æ–¥–∏–∫–µ)
    algo_version TEXT,                       -- –í–µ—Ä—Å–∏—è —Ñ–æ—Ä–º—É–ª
    created_at INTEGER DEFAULT (strftime('%s', 'now') * 1000),
    updated_at INTEGER DEFAULT (strftime('%s', 'now') * 1000)
);

-- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è trades
CREATE INDEX IF NOT EXISTS idx_trades_symbol_opened ON trades(symbol, opened_at);
CREATE INDEX IF NOT EXISTS idx_trades_exit_time ON trades(exit_time);
CREATE INDEX IF NOT EXISTS idx_trades_mode_status ON trades(mode, status);
CREATE INDEX IF NOT EXISTS idx_trades_signal_id ON trades(signal_id);

-- =====================================
-- 4) TRADE_EVENTS ‚Äî –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –ª–µ–Ω—Ç–∞ —Å–æ–±—ã—Ç–∏–π –ø–æ —Å–¥–µ–ª–∫–µ
-- =====================================

CREATE TABLE IF NOT EXISTS trade_events (
    id TEXT PRIMARY KEY,                       -- UUID —Å–æ–±—ã—Ç–∏—è
    trade_id TEXT NOT NULL REFERENCES trades(id), -- –°–¥–µ–ª–∫–∞
    ts INTEGER NOT NULL,                       -- –í—Ä–µ–º—è —Å–æ–±—ã—Ç–∏—è
    event_type TEXT NOT NULL,                  -- tp1/tp2/.../sl/be_move/timeout
    event_price REAL NOT NULL,                 -- –¶–µ–Ω–∞ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è
    event_note TEXT,                          -- –î–æ–ø. –∏–Ω—Ñ–æ
    snapshot_json TEXT,                        -- –°—Ä–µ–∑ –ø–æ–∑–∏—Ü–∏–∏/–ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ JSON
    created_at INTEGER DEFAULT (strftime('%s', 'now') * 1000)
);

-- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è trade_events
CREATE INDEX IF NOT EXISTS idx_trade_events_trade_ts ON trade_events(trade_id, ts);
CREATE INDEX IF NOT EXISTS idx_trade_events_type ON trade_events(event_type);

-- =====================================
-- 5) TRADE_AUDITS ‚Äî –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞—É–¥–∏—Ç —Å–¥–µ–ª–∫–∏
-- =====================================

CREATE TABLE IF NOT EXISTS trade_audits (
    trade_id TEXT PRIMARY KEY REFERENCES trades(id),
    tp_hits_json TEXT NOT NULL,               -- {tp1:{hit,time,price}, ...} JSON
    tp_sequence_json TEXT NOT NULL,           -- –°–æ–±—ã—Ç–∏—è –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (["TP1","TP2","BE","SL"]) JSON
    tp_first_hit_time INTEGER,               -- –í—Ä–µ–º—è –ø–µ—Ä–≤–æ–≥–æ TP
    tp_depth INTEGER,                        -- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç—ã–π TP-–Ω–æ–º–µ—Ä
    sl_hit_time INTEGER,                     -- –í—Ä–µ–º—è SL (–µ—Å–ª–∏ –±—ã–ª–æ)
    mae_pct REAL NOT NULL,                   -- Max adverse excursion % –º–∞—Ä–∂–∏
    mae_time INTEGER,                        -- –ö–æ–≥–¥–∞ —Å–ª—É—á–∏–ª—Å—è MAE
    mfe_pct REAL NOT NULL,                   -- Max favorable excursion % –º–∞—Ä–∂–∏
    mfe_time INTEGER,                        -- –ö–æ–≥–¥–∞ —Å–ª—É—á–∏–ª—Å—è MFE
    t_to_tp_map_json TEXT,                   -- {tp1:sec,tp2:sec,...} JSON
    fake_tp_flags_json TEXT,                 -- {tp1:false,tp2:true,...} (high/low check) JSON
    audit_version TEXT NOT NULL,             -- –í–µ—Ä—Å–∏—è –∞—É–¥–∏—Ç–∞
    updated_at INTEGER NOT NULL DEFAULT (strftime('%s', 'now') * 1000)
);

-- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è trade_audits
CREATE INDEX IF NOT EXISTS idx_trade_audits_tp_depth ON trade_audits(tp_depth);
CREATE INDEX IF NOT EXISTS idx_trade_audits_mae ON trade_audits(mae_pct);
CREATE INDEX IF NOT EXISTS idx_trade_audits_mfe ON trade_audits(mfe_pct);

-- =====================================
-- 6) STRATEGIES ‚Äî –∫–∞—Ç–∞–ª–æ–≥ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è
-- =====================================

CREATE TABLE IF NOT EXISTS strategies (
    strategy_id TEXT PRIMARY KEY,             -- ID
    name TEXT NOT NULL,                       -- –ß–∏—Ç–∞–±–µ–ª—å–Ω–æ–µ –∏–º—è
    description TEXT,                         -- –û–ø–∏—Å–∞–Ω–∏–µ
    params_json TEXT NOT NULL,                -- –î–æ–ª–∏/BE/—Ç—Ä–µ–π–ª–∏–Ω–≥/timeout –∏ —Ç.–ø. JSON
    version TEXT NOT NULL,                    -- –í–µ—Ä—Å–∏—è
    enabled INTEGER NOT NULL DEFAULT 1 CHECK (enabled IN (0,1)), -- –ê–∫—Ç–∏–≤–Ω–∞
    created_at INTEGER DEFAULT (strftime('%s', 'now') * 1000),
    updated_at INTEGER DEFAULT (strftime('%s', 'now') * 1000)
);

-- –ò–Ω–¥–µ–∫—Å –¥–ª—è strategies
CREATE INDEX IF NOT EXISTS idx_strategies_enabled ON strategies(enabled);

-- =====================================
-- 7) STRATEGY_RESULTS ‚Äî –∫—ç—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø–æ –∫–∞–∂–¥–æ–π —Å–¥–µ–ª–∫–µ –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
-- =====================================

CREATE TABLE IF NOT EXISTS strategy_results (
    trade_id TEXT NOT NULL REFERENCES trades(id),
    strategy_id TEXT NOT NULL REFERENCES strategies(strategy_id),
    computed_at INTEGER NOT NULL,             -- –ö–æ–≥–¥–∞ –ø–æ—Å—á–∏—Ç–∞–ª–∏
    algo_version TEXT NOT NULL,               -- –í–µ—Ä—Å–∏—è —Å–∏–º—É–ª—è—Ç–æ—Ä–∞
    pnl_usdt REAL NOT NULL,                  -- –ò—Ç–æ–≥–æ–≤—ã–π PnL (net)
    roi_pct REAL NOT NULL,                   -- –ò—Ç–æ–≥–æ–≤—ã–π ROI% –æ—Ç –º–∞—Ä–∂–∏
    win_flag INTEGER NOT NULL CHECK (win_flag IN (0,1)), -- Win/Loss –ø–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
    tp_depth INTEGER,                        -- –î–æ—Å—Ç–∏–≥–Ω—É—Ç—ã–π TPn –≤ –º–æ–¥–µ–ª–∏
    mae_pct REAL,                           -- MAE –≤ –º–æ–¥–µ–ª–∏
    mfe_pct REAL,                           -- MFE –≤ –º–æ–¥–µ–ª–∏
    t_to_tp_map_json TEXT,                  -- –¢–∞–π–º–∏–Ω–≥–∏ –¥–æ —Ü–µ–ª–µ–π JSON
    fees_est REAL,                          -- –ö–æ–º–∏—Å—Å–∏–∏ (–º–µ—Ç–æ–¥–∏–∫–∞ –∫–∞–∫ –≤ —Ç—Ä–µ–∫–µ—Ä–µ)
    created_at INTEGER DEFAULT (strftime('%s', 'now') * 1000),
    
    UNIQUE(trade_id, strategy_id)
);

-- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è strategy_results
CREATE INDEX IF NOT EXISTS idx_strategy_results_strategy ON strategy_results(strategy_id);
CREATE INDEX IF NOT EXISTS idx_strategy_results_roi ON strategy_results(roi_pct);
CREATE INDEX IF NOT EXISTS idx_strategy_results_pnl ON strategy_results(pnl_usdt);

-- =====================================
-- 8) TRADERS ‚Äî —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —Ç—Ä–µ–π–¥–µ—Ä–æ–≤/–∫–∞–Ω–∞–ª–æ–≤
-- =====================================

CREATE TABLE IF NOT EXISTS traders (
    trader_id TEXT PRIMARY KEY,              -- ID/slug
    name TEXT NOT NULL,                      -- –ò–º—è/–ø—Å–µ–≤–¥–æ–Ω–∏–º
    source_type TEXT,                        -- telegram/discord/ai
    is_traded INTEGER NOT NULL DEFAULT 0 CHECK (is_traded IN (0,1)), -- –í —Ä–µ–∞–ª—å–Ω–æ–º –ø–æ—Ä—Ç—Ñ–µ–ª–µ?
    trust_score REAL,                        -- –ò–Ω–¥–µ–∫—Å –¥–æ–≤–µ—Ä–∏—è
    status TEXT,                             -- üî•/üü°/üî¥/üõë/‚ö™
    created_at INTEGER NOT NULL DEFAULT (strftime('%s', 'now') * 1000),
    updated_at INTEGER NOT NULL DEFAULT (strftime('%s', 'now') * 1000)
);

-- –ò–Ω–¥–µ–∫—Å –¥–ª—è traders
CREATE INDEX IF NOT EXISTS idx_traders_status ON traders(status);
CREATE INDEX IF NOT EXISTS idx_traders_traded ON traders(is_traded);

-- =====================================
-- 9) TRADER_STATS ‚Äî –∞–≥—Ä–µ–≥–∞—Ç—ã –ø–æ —Ç—Ä–µ–π–¥–µ—Ä—É (–ø–æ –ø–µ—Ä–∏–æ–¥—É –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏)
-- =====================================

CREATE TABLE IF NOT EXISTS trader_stats (
    trader_id TEXT NOT NULL REFERENCES traders(trader_id),
    period_key TEXT NOT NULL,                -- 7d/30d/ytd/all
    strategy_id TEXT NOT NULL,               -- –î–ª—è —á–µ—Å—Ç–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
    trades_cnt INTEGER NOT NULL,             -- –ö–æ–ª-–≤–æ —Å–¥–µ–ª–æ–∫
    winrate_pct REAL NOT NULL,              -- % –ø–æ–±–µ–¥
    roi_avg_pct REAL NOT NULL,              -- –°—Ä. ROI%
    pnl_usdt REAL NOT NULL,                 -- –°—É–º–º–∞—Ä–Ω—ã–π PnL
    max_dd_pct REAL,                        -- –ú–∞–∫—Å. –ø—Ä–æ—Å–∞–¥–∫–∞
    tp1_pct REAL,                           -- –î–æ–ª—è TP1-–∫–∞—Å–∞–Ω–∏–π
    tp2_pct REAL,                           -- –î–æ–ª—è TP2-–∫–∞—Å–∞–Ω–∏–π
    tp3_pct REAL,                           -- –î–æ–ª—è TP3-–∫–∞—Å–∞–Ω–∏–π
    avg_t_to_tp1 REAL,                      -- –°—Ä. –≤—Ä–µ–º—è –¥–æ TP1 (—Å–µ–∫)
    avg_t_to_tp2 REAL,                      -- –°—Ä. –≤—Ä–µ–º—è –¥–æ TP2 (—Å–µ–∫)
    avg_mae_pct REAL,                       -- –°—Ä. MAE %
    avg_mfe_pct REAL,                       -- –°—Ä. MFE %
    roi_trend_sign INTEGER CHECK (roi_trend_sign IN (-1,0,1)), -- –¢—Ä–µ–Ω–¥ ROI
    updated_at INTEGER NOT NULL DEFAULT (strftime('%s', 'now') * 1000),
    
    UNIQUE(trader_id, period_key, strategy_id)
);

-- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è trader_stats
CREATE INDEX IF NOT EXISTS idx_trader_stats_trader_period ON trader_stats(trader_id, period_key);
CREATE INDEX IF NOT EXISTS idx_trader_stats_strategy ON trader_stats(strategy_id);

-- =====================================
-- 10) SCENARIOS & SCENARIO_RESULTS ‚Äî what-if —Ñ–∏–ª—å—Ç—Ä—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
-- =====================================

CREATE TABLE IF NOT EXISTS scenarios (
    scenario_id TEXT PRIMARY KEY,
    title TEXT NOT NULL,
    json_filter TEXT NOT NULL,               -- JSON filter
    created_at INTEGER DEFAULT (strftime('%s', 'now') * 1000)
);

CREATE TABLE IF NOT EXISTS scenario_results (
    scenario_id TEXT NOT NULL REFERENCES scenarios(scenario_id),
    trader_id TEXT NOT NULL,
    period_key TEXT NOT NULL,
    pnl_usdt REAL NOT NULL,
    roi_pct REAL NOT NULL,
    winrate REAL NOT NULL,
    trades_cnt INTEGER NOT NULL,
    computed_at INTEGER NOT NULL,
    
    UNIQUE(scenario_id, trader_id, period_key)
);

-- =====================================
-- 11) VIEWS –ø–æ–¥ UI (–∫–æ–ª–æ–Ω–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∏—Ä—É—é—â–∏—Ö –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π)
-- =====================================

-- vw_kpi_summary - –æ–±—â–∏–µ KPI
CREATE VIEW IF NOT EXISTS vw_kpi_summary AS
SELECT 
    'global' as scope,
    period_key as period,
    strategy_id,
    SUM(pnl_usdt) as total_pnl_usdt,
    SUM(trades_cnt) as total_trades,
    AVG(winrate_pct) as winrate_pct,
    SUM(CASE WHEN pnl_usdt > 0 THEN pnl_usdt ELSE 0 END) as pnl_long,
    SUM(CASE WHEN pnl_usdt < 0 THEN pnl_usdt ELSE 0 END) as pnl_short,
    MAX(updated_at) as updated_at
FROM trader_stats 
GROUP BY period_key, strategy_id;

-- vw_trader_ranking - —Ä–µ–π—Ç–∏–Ω–≥ —Ç—Ä–µ–π–¥–µ—Ä–æ–≤
CREATE VIEW IF NOT EXISTS vw_trader_ranking AS
SELECT 
    ts.trader_id,
    t.name,
    ts.trades_cnt,
    ts.winrate_pct,
    ts.roi_avg_pct,
    ts.pnl_usdt,
    ts.max_dd_pct,
    ts.tp1_pct,
    ts.tp2_pct,
    ts.tp3_pct,
    ts.avg_t_to_tp1,
    t.trust_score,
    ts.roi_trend_sign,
    t.status,
    ts.updated_at,
    ts.period_key,
    ts.strategy_id
FROM trader_stats ts
JOIN traders t ON ts.trader_id = t.trader_id;

-- =====================================
-- –ù–ê–ß–ê–õ–¨–ù–´–ï –î–ê–ù–ù–´–ï
-- =====================================

-- –ë–∞–∑–æ–≤—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
INSERT OR IGNORE INTO strategies (strategy_id, name, description, params_json, version) VALUES
('tp2_sl_be', 'TP2 & SL ‚Üí BE', '–î–≤–∞ —Ç–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç–∞, —Å—Ç–æ–ø –≤ –±–µ–∑—É–±—ã—Ç–æ–∫', '{"tp1_portion": 0.5, "tp2_portion": 0.5, "be_after_tp1": true}', 'v1.0'),
('scalping', 'Scalping', '–ë—ã—Å—Ç—Ä—ã–µ —Å–¥–µ–ª–∫–∏, –º–∞–ª—ã–π –ø—Ä–æ—Ñ–∏—Ç', '{"tp1_portion": 1.0, "quick_exit": true, "max_duration": 3600}', 'v1.0'),
('swing', 'Swing Trading', '–°—Ä–µ–¥–Ω–µ-—Å—Ä–æ—á–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏', '{"tp1_portion": 0.3, "tp2_portion": 0.7, "max_duration": 86400}', 'v1.0'),
('all', '–í—Å–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏', '–°–º–µ—à–∞–Ω–Ω–∞—è —Ç–æ—Ä–≥–æ–≤–ª—è', '{"adaptive": true}', 'v1.0');

-- –¢–µ—Å—Ç–æ–≤—ã–π —Ç—Ä–µ–π–¥–µ—Ä
INSERT OR IGNORE INTO traders (trader_id, name, source_type, status) VALUES
('ZTrade', 'ZTrade', 'telegram', 'üî•'),
('whales_guide', 'Whales Crypto Guide', 'telegram', 'üî•'),
('test_trader', 'Test Trader', 'telegram', '‚ö™');

-- =====================================
-- –ó–ê–í–ï–†–®–ï–ù–ò–ï
-- =====================================

-- –í–∫–ª—é—á–∞–µ–º –≤–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏
PRAGMA foreign_keys = ON;

SELECT 
    'GHOST Full Database Schema v1.1 —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ! üéâ' as status,
    '–¢–∞–±–ª–∏—Ü —Å–æ–∑–¥–∞–Ω–æ: 11 –æ—Å–Ω–æ–≤–Ω—ã—Ö + 2 VIEW' as tables_info,
    '–ì–æ—Ç–æ–≤–∞ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ —Å–±–æ—Ä–∞/–∞—É–¥–∏—Ç–∞ —Å–∏–≥–Ω–∞–ª–æ–≤' as ready_status;
