-- Supabase full trades table (mirror of Daren's SQLite `trades`)
-- Safe to run multiple times (IF NOT EXISTS guards)

create table if not exists public.trades (
  id text primary key,
  trade_id text,
  symbol text,
  side text,
  leverage integer,
  source text,
  source_type text,
  source_name text,
  source_id integer,
  entry_zone text,
  entry_type text,
  entry_exec_price numeric,
  entry numeric,
  fill_type text,
  tp1 numeric,
  tp2 numeric,
  tp3 numeric,
  sl numeric,
  tp1_price numeric,
  tp2_price numeric,
  sl_price numeric,
  tp1_auto_calc numeric,
  sl_auto_calc numeric,
  sl_type text,
  real_entry_price numeric,
  position_qty numeric,
  margin_usd numeric,
  verdict_reason text,
  opened_at timestamptz,
  updated_at timestamptz,
  real_leverage numeric,
  margin_used numeric,
  entry_min numeric,
  entry_max numeric,
  avg_entry_price numeric,
  entry_method text,
  risk_pct numeric,
  source_leverage text,
  raw_symbol text,
  targets text,
  tp_weights text,
  original_text text,
  signal_reason text,
  note text,
  exit_time timestamptz,
  exit_reason text,
  roi_percent numeric,
  verdict text,
  gpt_comment text,
  exit_trigger_type text,
  exit_trigger_value text,
  ghost_exit_score numeric,
  order_id text,
  execution_type text,
  fill_status text,
  avg_fill_price numeric,
  fee_rate numeric,
  fee_paid numeric,
  model_id text,
  strategy_version text,
  signal_sequence integer,
  consensus_score numeric,
  consensus_sources text,
  status text,
  closed_at timestamptz,
  realized_pnl numeric,
  exit text,
  finalized boolean,
  roi_planned numeric,
  pnl_gross numeric,
  pnl_net numeric,
  roi_gross numeric,
  entry_price_bybit numeric,
  exit_price_bybit numeric,
  exit_price_fallback numeric,
  roi_percent_bybit numeric,
  roi_estimated numeric,
  entry_slippage numeric,
  exit_slippage numeric,
  entry_latency_ms integer,
  exit_latency_ms integer,
  data_source_mode text,
  weekday integer,
  weekday_name text,
  opened_at_full text,
  roi_bybit_style numeric,
  bybit_fee_open numeric,
  bybit_fee_close numeric,
  bybit_fee_total numeric,
  bybit_pnl_net numeric,
  commission_over_roi numeric,
  loss_type text,
  anomaly_flag boolean,
  bybit_pnl_net_api numeric,
  order_id_exit text,
  signal_id text,
  bybit_pnl_net_fallback numeric,
  order_id_exit_fallback text,
  roi_source text,
  tp_hit text,
  exit_detail text,
  roi_ui numeric,
  pnl_net_initial numeric,
  roi_percent_initial numeric,
  tp1_hit boolean,
  tp2_hit boolean,
  sl_hit boolean,
  early_exit boolean,
  early_exit_reason text,
  exit_explanation text,
  exit_ai_score numeric,
  tp_count_hit integer,
  roi_sl_expected numeric,
  expected_profit_tp1 numeric,
  expected_loss_sl numeric,
  expected_profit_tp2 numeric,
  expected_profit_total numeric,
  duration_sec integer,
  leverage_used_expected numeric,
  tp1_order_id text,
  tp2_order_id text,
  sl_order_id text,
  sl_be_moved boolean,
  sl_be_method text,
  tp2_restore_attempted boolean default false,
  tp2_order_id_current text,
  tp2_order_id_history text,
  sl_order_id_current text,
  sl_order_id_history text,
  tp2_restore_attempts integer default 0,
  pnl_tp1 numeric,
  pnl_tp2 numeric,
  roi_tp1 numeric,
  roi_tp2 numeric,
  roi_final_real numeric,
  pnl_final_real numeric,
  profit_tp1_real numeric,
  profit_tp2_real numeric,
  fee_tp1 numeric,
  fee_tp2 numeric,
  pnl_tp1_net numeric,
  pnl_tp2_net numeric,
  roi_tp1_real numeric,
  roi_tp2_real numeric,
  roi_sl_real numeric,
  tp2_exit_type text,
  tp1_hit_time timestamptz,
  tp2_hit_time timestamptz,
  sl_hit_time timestamptz,
  tp1_duration_sec integer,
  tp2_duration_sec integer,
  sl_duration_sec integer,
  manual_exit integer,
  manual_exit_type text,
  sl_to_be integer,
  sl_be_price numeric,
  pnl_source text,
  raw_fills_count integer,
  fills_legA text,
  fills_legB text,
  fills_legA_vwap numeric,
  fills_legB_vwap numeric,
  fills_legA_qty numeric,
  fills_legB_qty numeric,
  fills_legA_fee numeric,
  fills_legB_fee numeric,
  fills_legA_fee_in numeric,
  fills_legB_fee_in numeric
);

-- Helpful indexes
create index if not exists trades_symbol_opened_idx on public.trades(symbol, opened_at desc);
create index if not exists trades_closed_idx on public.trades(closed_at desc);
create index if not exists trades_status_idx on public.trades(status);


